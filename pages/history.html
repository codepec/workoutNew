<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Iron Insanity ‚Äî History</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#00FF66">
<link rel="stylesheet" href="../styles/app.css">

<style>

.content{
  padding:25px;
  display:flex;
  flex-direction:column;
  margin-top:20px;
}

.card{
  background:#111827;
  border:2px solid #374151;
  border-radius:20px;
  padding:18px;
  margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
}

.entry-title{
  font-weight:900;
  font-size:1.05rem;
  margin-bottom:10px;
}

.row{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin-top:10px;
}

.badge{
  background:#020617;
  border:1px solid #1f2937;
  border-radius:14px;
  padding:10px;
  text-align:center;
}

.badge-label{
  font-size:.65rem;
  opacity:.6;
}

.badge-value{
  font-size:.95rem;
  font-weight:800;
}

/* ACHIEVEMENTS */

.ach-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
  gap:12px;
  margin-top:12px;
}

.ach{
  background:#020617;
  border:2px solid #1f2937;
  border-radius:14px;
  padding:12px;
  text-align:center;
  font-size:.85rem;
  opacity:.45;
}

.ach.unlocked{
  border-color:#22c55e;
  color:#22c55e;
  opacity:1;
  box-shadow:0 0 12px rgba(34,197,94,.5);
}

.hint{
  opacity:.6;
  text-align:center;
  margin-top:10px;
}

</style>
</head>

<body>

<div class="content">

<div class="sub">History</div>

<div id="summary" class="card"></div>

<div id="achievements" class="card">
  <div class="entry-title">üèÜ Achievements</div>
  <div class="ach-grid" id="achGrid"></div>
</div>

<div id="historyList"></div>

<div id="hint" class="hint"></div>

</div>

<script>

/* ======================
   FORMAT HELPERS
====================== */

function fmtDateBlock(ts){
  const d = new Date(ts);
  return `
    <div>${d.toLocaleDateString("de-DE",{weekday:"long"})}</div>
    <div>${d.toLocaleDateString()}</div>
    <div>${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
  `;
}

function fmtDuration(ms){
  return Math.round(ms/60000)+" min";
}

/* ======================
   XP + LEVEL
====================== */

/* Neue XP-Logik passend zu cards.html */
function calcXP(e){
  if(e.exercises){
    // Summiere XP pro √úbung inkl. eventueller Adjustments
    return e.exercises.reduce((s,ex,idx)=>{
      let key = `${idx}_0`;
      const adjust = e.xpAdjustments?.[key]||0;
      return s + (ex.xp || 0) + adjust;
    },0);
  }
  // Fallback f√ºr √§ltere Eintr√§ge ohne exercises
  return e.xp || 0;
}

function calcLevel(xp){
  return Math.floor(xp/500)+1;
}

/* ======================
   STREAK
====================== */

function calcStreak(list){
  if(list.length===0) return 0;

  const days = [...new Set(list.map(e =>
    new Date(e.start).toDateString()
  ))].sort().reverse();

  let s=1;
  for(let i=1;i<days.length;i++){
    const a=new Date(days[i-1]);
    const b=new Date(days[i]);
    if((a-b)/(86400000)===1) s++;
    else break;
  }
  return s;
}

/* ======================
   ACHIEVEMENTS
====================== */

const ACH = [
  {label:"First Blood", rule:s=>s.count>=1},
  {label:"Rookie", rule:s=>s.count>=3},
  {label:"Committed", rule:s=>s.count>=5},
  {label:"Addicted", rule:s=>s.count>=10},
  {label:"Unstoppable", rule:s=>s.count>=25},
  {label:"Machine", rule:s=>s.count>=50},
  {label:"Streak 3", rule:s=>s.streak>=3},
  {label:"Streak 5", rule:s=>s.streak>=5},
  {label:"Streak 7", rule:s=>s.streak>=7},
  {label:"Streak 14", rule:s=>s.streak>=14},
  {label:"Streak 30", rule:s=>s.streak>=30},
  {label:"XP 500", rule:s=>s.xp>=500},
  {label:"XP 1000", rule:s=>s.xp>=1000},
  {label:"XP 2500", rule:s=>s.xp>=2500},
  {label:"XP 5000", rule:s=>s.xp>=5000},
  {label:"XP 10000", rule:s=>s.xp>=10000},
  {label:"1h Total", rule:s=>s.totalMin>=60},
  {label:"3h Total", rule:s=>s.totalMin>=180},
  {label:"5h Total", rule:s=>s.totalMin>=300},
  {label:"10h Total", rule:s=>s.totalMin>=600},
  {label:"Hardcore", rule:s=>s.hard>=1},
  {label:"Beast Mode", rule:s=>s.hard>=5},
  {label:"Savage", rule:s=>s.hard>=10},
  {label:"Push Master", rule:s=>s.push>=10},
  {label:"Pull Master", rule:s=>s.pull>=10},
  {label:"Leg Day Hero", rule:s=>s.legs>=10},
  {label:"Early Bird", rule:s=>s.morning>=5},
  {label:"Night Grinder", rule:s=>s.night>=5},
  {label:"Weekend Warrior", rule:s=>s.weekend>=5},
  {label:"Marathon", rule:s=>s.long>=1},
  {label:"Ultra Session", rule:s=>s.long>=5},
  {label:"Speed Runner", rule:s=>s.short>=5},
];


/* ======================
   SUMMARY
====================== */

function renderSummary(list){

 const xp = list.reduce((s,e)=>s+calcXP(e),0);
 const dur = list.reduce((s,e)=>s+e.duration,0);
 const level = calcLevel(xp);
 const streak = calcStreak(list);

 const stats = {
  xp,
  count:list.length,
  streak,
  totalMin: Math.round(dur/60000),
  hard: list.filter(e=>e.difficulty>1.2).length,
  push: list.filter(e=>e.day==="Push").length,
  pull: list.filter(e=>e.day==="Pull").length,
  legs: list.filter(e=>e.day==="Legs").length,
  long: list.filter(e=>e.duration>90*60000).length,
  short: list.filter(e=>e.duration<20*60000).length,
  morning: list.filter(e=>{
    const h=new Date(e.start).getHours();
    return h<10;
  }).length,
  night: list.filter(e=>{
    const h=new Date(e.start).getHours();
    return h>=20;
  }).length,
  weekend: list.filter(e=>{
    const d=new Date(e.start).getDay();
    return d===0 || d===6;
  }).length
 };

 summary.innerHTML = `
 <div class="entry-title">üî• Progress</div>
 <div class="row">
  <div class="badge"><div class="badge-label">Workouts</div><div class="badge-value">${stats.count}</div></div>
  <div class="badge"><div class="badge-label">Zeit</div><div class="badge-value">${stats.totalMin}m</div></div>
  <div class="badge"><div class="badge-label">XP</div><div class="badge-value">${xp}</div></div>
  <div class="badge"><div class="badge-label">Level</div><div class="badge-value">${level}</div></div>
 </div>`;

 return stats;
}


/* ======================
   ACH RENDER
====================== */

function renderAchievements(stats){

 achGrid.innerHTML="";

 ACH.forEach(a=>{
   if(a.rule(stats)){
     const el=document.createElement("div");
     el.className="ach unlocked";
     el.innerText=a.label;
     achGrid.appendChild(el);
   }
 });

 if(achGrid.children.length===0){
   achGrid.innerHTML="<div class='hint'>Noch keine Achievements freigeschaltet</div>";
 }
}


/* ======================
   ENTRY CARD
====================== */

function renderEntry(e){

 const card=document.createElement("div");
 card.className="card";

 card.innerHTML=`
  <div class="entry-title">
   Woche ${e.week} ‚Äî ${e.day}
  </div>

  <div class="row">
   <div class="badge">
    <div class="badge-label">Start</div>
    <div class="badge-value">${fmtDateBlock(e.start)}</div>
   </div>

   <div class="badge">
    <div class="badge-label">Ende</div>
    <div class="badge-value">${fmtDateBlock(e.end)}</div>
   </div>

   <div class="badge">
    <div class="badge-label">Dauer</div>
    <div class="badge-value">${fmtDuration(e.duration)}</div>
   </div>

   <div class="badge">
    <div class="badge-label">XP</div>
    <div class="badge-value">${calcXP(e)}</div>
   </div>
  </div>
 `;

 return card;
}

/* ======================
   LOAD
====================== */

function load(){

 const list = JSON.parse(localStorage.getItem("history")||"[]");

 if(list.length===0){
   hint.innerText="Noch keine Trainings abgeschlossen.";
   return;
 }

 const stats = renderSummary(list);
 renderAchievements(stats);

 list.slice().reverse().forEach(e=>{
   historyList.appendChild(renderEntry(e));
 });

}

load();

</script>

<script src="../components/layout.js"></script>
<script>
loadLayout("../pages/history.html","../index.html");
</script>

</body>
</html>
