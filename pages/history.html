<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Iron Insanity ‚Äî History</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#00FF66">

<link rel="stylesheet" href="../styles/app.css">
<link rel="stylesheet" href="../styles/history.css">
</head>

<body>

<div class="app-wrap">

<!-- =========================
   HERO / HEADER
========================= -->
<div class="hero">
  <div class="hero-inner">
    <div class="hero-title">History</div>
    <div class="hero-sub">Deine Trainingsstatistiken</div>
    <div class="hero-sub">Workouts, XP & Achievements</div>
  </div>
</div>

<!-- =========================
   CONTENT
========================= -->
<div class="content">

  <div id="summary" class="card"></div>

  <div class="card">
    <div class="entry-title">üèÜ Achievements</div>
    <div class="ach-grid" id="achGrid"></div>
  </div>

  <div id="historyList"></div>

  <div id="hint" class="hint"></div>

</div>

</div> <!-- app-wrap end -->


<script>
/* ======================
   FORMAT HELPERS
====================== */
function fmtDateBlock(ts){
  const d = new Date(ts);
  return `
    <div>${d.toLocaleDateString("de-DE",{weekday:"long"})}</div>
    <div>${d.toLocaleDateString()}</div>
    <div>${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
  `;
}

function fmtDuration(ms){
  return Math.round(ms/60000)+" min";
}

/* ======================
   XP + LEVEL
====================== */
function calcXP(e){
  if(e.exercises){
    return e.exercises.reduce((s,ex,idx)=>{
      let key = `${idx}_0`;
      const adjust = e.xpAdjustments?.[key] || 0;
      return s + (ex.xp || 0) + adjust;
    },0);
  }
  return e.xp || 0;
}

function calcLevel(xp){
  return Math.floor(xp/500)+1;
}

/* ======================
   STREAK
====================== */
function calcStreak(list){
  if(list.length===0) return 0;

  const days = [...new Set(
    list.map(e=>new Date(e.start).toDateString())
  )].sort().reverse();

  let s=1;
  for(let i=1;i<days.length;i++){
    const a=new Date(days[i-1]);
    const b=new Date(days[i]);
    if((a-b)/(86400000)===1) s++;
    else break;
  }
  return s;
}

/* ======================
   ACHIEVEMENTS
====================== */
const ACH = [
  {label:"First Blood", rule:s=>s.count>=1},
  {label:"Rookie", rule:s=>s.count>=3},
  {label:"Committed", rule:s=>s.count>=5},
  {label:"Addicted", rule:s=>s.count>=10},
  {label:"Streak 3", rule:s=>s.streak>=3},
  {label:"XP 500", rule:s=>s.xp>=500},
];

/* ======================
   SUMMARY
====================== */
function renderSummary(list){
  const xp = list.reduce((s,e)=>s+calcXP(e),0);
  const dur = list.reduce((s,e)=>s+(e.duration||0),0);
  const level = calcLevel(xp);
  const streak = calcStreak(list);

  const stats = {
    xp,
    count:list.length,
    streak,
    totalMin:Math.round(dur/60000)
  };

  document.getElementById("summary").innerHTML = `
    <div class="entry-title">üî• Progress</div>
    <div class="row">
      <div class="badge">
        <div class="badge-label">Workouts</div>
        <div class="badge-value">${stats.count}</div>
      </div>
      <div class="badge">
        <div class="badge-label">Zeit</div>
        <div class="badge-value">${stats.totalMin}m</div>
      </div>
      <div class="badge">
        <div class="badge-label">XP</div>
        <div class="badge-value">${xp}</div>
      </div>
      <div class="badge">
        <div class="badge-label">Level</div>
        <div class="badge-value">${level}</div>
      </div>
    </div>`;

  return stats;
}

/* ======================
   ACH RENDER
====================== */
function renderAchievements(stats){
  const achGrid = document.getElementById("achGrid");
  achGrid.innerHTML="";

  ACH.forEach(a=>{
    if(a.rule(stats)){
      const el=document.createElement("div");
      el.className="ach unlocked";
      el.innerText=a.label;
      achGrid.appendChild(el);
    }
  });

  if(achGrid.children.length===0){
    achGrid.innerHTML="<div class='hint'>Noch keine Achievements freigeschaltet</div>";
  }
}

/* ======================
   ENTRY CARD
====================== */
function renderEntry(e){
  const card=document.createElement("div");
  card.className="card";

  card.innerHTML=`
    <div class="entry-title">
      Woche ${e.week} ‚Äî ${e.day}
    </div>
    <div class="row">
      <div class="badge">
        <div class="badge-label">Start</div>
        <div class="badge-value">${fmtDateBlock(e.start)}</div>
      </div>
      <div class="badge">
        <div class="badge-label">Ende</div>
        <div class="badge-value">${fmtDateBlock(e.end)}</div>
      </div>
      <div class="badge">
        <div class="badge-label">Dauer</div>
        <div class="badge-value">${fmtDuration(e.duration||0)}</div>
      </div>
      <div class="badge">
        <div class="badge-label">XP</div>
        <div class="badge-value">${calcXP(e)}</div>
      </div>
    </div>`;

  return card;
}

/* ======================
   LOAD
====================== */
function load(){
  const historyList = document.getElementById("historyList");
  const hint = document.getElementById("hint");

  historyList.innerHTML = "";
  hint.innerText = "";

  const list = JSON.parse(localStorage.getItem("history")||"[]");

  if(list.length===0){
    hint.innerText="Noch keine Trainings abgeschlossen.";
    return;
  }

  const stats = renderSummary(list);
  renderAchievements(stats);

  list.slice().reverse().forEach(e=>{
    historyList.appendChild(renderEntry(e));
  });
}

load();
</script>

<script src="../components/layout.js"></script>
<script>
loadLayout("../pages/history.html","../index.html");
</script>

</body>
</html>