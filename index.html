<!doctype html>
<html lang="de" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<base href="/workoutNew/">

<title>Iron Insanity</title>
<meta name="theme-color" content="#0f172a">

<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

<link rel="stylesheet" href="styles/app.css">
<link rel="stylesheet" href="styles/index.css">

</head>

<body>

<div class="hero-card">

  <div class="label-card" id="rankBox"></div>
  <div class="label-card exercise" id="missionBox"></div>

  <div class="progress-week-box">
    <div class="progress-details">

      <div class="progress-item">
        <div id="xpProgressText"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="xpProgressFill"></div>
        </div>
      </div>

      <div class="progress-item">
        <div id="weekProgressText"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="weekProgressFill"></div>
        </div>
      </div>

    </div>
  </div>

  <div id="trainGrid" class="train-grid"></div>

  <button class="start-btn" id="startBtn"></button>
  <button class="secondary-btn" onclick="changeWeek()">Woche wechseln</button>

</div>


<!-- LAYOUT LADEN -->
<script type="module">
  import { loadLayout } from 'components/layoutMain.js';
  loadLayout(window.location.pathname);
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {

  const rankBox = document.getElementById("rankBox");
  const xpProgressFill = document.getElementById("xpProgressFill");
  const xpProgressText = document.getElementById("xpProgressText");
  const weekProgressFill = document.getElementById("weekProgressFill");
  const weekProgressText = document.getElementById("weekProgressText");
  const missionBox = document.getElementById("missionBox");
  const trainGrid = document.getElementById("trainGrid");
  const startBtn = document.getElementById("startBtn");

  const order = ["Push","Pull","Legs"];
  let week = parseInt(localStorage.getItem("selectedWeek")) || 1;
  const MIN_PAUSE_HOURS = 24;

  const history = JSON.parse(localStorage.getItem("history")||"[]");
  const totalXp = Number(localStorage.getItem("totalXp")||0);
  const session = JSON.parse(localStorage.getItem("workoutSession")||"null");
  const lastDay = localStorage.getItem("lastDay");

  const RANKS = [];
  const baseNames = [
    "Rekrut","Krieger","ZerstÃ¶rer","Titan","Warlord","Champion",
    "Legende","Brutalizer","Kriegsherr","Eroberer","PhÃ¶nix",
    "Schattenlord","Apokalypt","Unsterblicher","Gottkrieger",
    "Mythos","Kosmokrat","Ewiger"
  ];

  for (let i=0;i<baseNames.length;i++){
    RANKS.push({n:baseNames[i],xp:i===0?0:Math.floor(Math.pow(i,2)*1200)});
  }

  function getRankData(xp){
    let current=RANKS[0];
    let next=null;
    for(let i=0;i<RANKS.length;i++){
      if(xp>=RANKS[i].xp){
        current=RANKS[i];
        next=RANKS[i+1]||null;
      }
    }
    return {current,next};
  }

  function weekMult(w){
    if(w>=7)return 1.6;
    if(w>=5)return 1.4;
    if(w>=3)return 1.2;
    return 1.0;
  }

  const MISSIONS={
    Push:"ðŸŽ¯ Brust & Trizeps sprengen",
    Pull:"ðŸŽ¯ RÃ¼cken & Bizeps zerstÃ¶ren",
    Legs:"ðŸŽ¯ UnterkÃ¶rper Kriegstag"
  };

  const rankData=getRankData(totalXp);

  rankBox.innerHTML=
    `ðŸŽ– Rang: ${rankData.current.n}
     <div class="small">XP ${totalXp} â€¢ Wochenbonus x${weekMult(week)}</div>`;

  let xpPct=100;
  let xpText="Max Rang erreicht";

  if(rankData.next){
    const span=rankData.next.xp-rankData.current.xp;
    const gained=totalXp-rankData.current.xp;
    xpPct=Math.min(100,(gained/span)*100);
    xpText=`${totalXp} / ${rankData.next.xp} XP â†’ ${rankData.next.n}`;
  }

  xpProgressFill.style.width=xpPct+"%";
  xpProgressText.innerText=xpText;

  weekProgressText.innerText=`Woche ${week}`;
  weekProgressFill.style.width=
    `${Math.min(100,(history.filter(e=>e.week===week).length/3)*100)}%`;

  const weekEntries = history.filter(e => e.week===week);
  const done = new Set(weekEntries.map(e=>e.day)).size;

  if(done>=3){
    week++;
    localStorage.setItem("selectedWeek",week);
    weekProgressText.innerText=`Woche ${week}`;
    weekProgressFill.style.width="0%";
    alert(`âœ… Woche ${week-1} abgeschlossen! Willkommen in Woche ${week}`);
  }

  function nextFrom(last){
    if(!last)return "Push";
    return order[(order.indexOf(last)+1)%3];
  }

  const nextDay=nextFrom(lastDay);

  let cooldown=0;
  const lastEntry=history.at(-1);

  if(lastEntry){
    cooldown=lastEntry.end+MIN_PAUSE_HOURS*3600000-Date.now();
  }

  function hoursLeft(ms){
    const h=Math.floor(ms/3600000);
    const m=Math.floor((ms%3600000)/60000);
    return h+"h "+m+"m";
  }

  missionBox.innerText=MISSIONS[nextDay];

  trainGrid.innerHTML="";

  order.forEach(day=>{
    let icon="ðŸ”’",txt="gesperrt";

    if(day===lastDay){
      icon="âœ…";
      txt="abgeschlossen";
    }

    if(day===nextDay){
      if(cooldown<=0){
        icon="ðŸ”¥";
        txt="bereitgestellt";
      }else{
        icon="â³";
        txt=hoursLeft(cooldown);
      }
    }

    trainGrid.innerHTML+=
      `<div class="train-row">
         <div>${day}</div>
         <div>${icon} ${txt}</div>
       </div>`;
  });

  if(session && session.finished===false){
    startBtn.innerText="Training fortsetzen";
    startBtn.onclick=()=>location.href="pages/cards.html";
  }
  else if(cooldown>0){
    startBtn.innerText="â³ Regeneration "+hoursLeft(cooldown);
    startBtn.classList.add("locked");
    startBtn.disabled=true;
  }
  else{
    startBtn.innerText="ðŸš€ Mission starten";
    startBtn.onclick=()=>{
      localStorage.setItem("workoutSession",
        JSON.stringify({
          week,
          day:nextDay,
          startedAt:Date.now(),
          finished:false,
          difficultyFactor:1
        })
      );
      location.href="pages/cards.html";
    };
  }

});

function changeWeek(){
  location.href="pages/week.html";
}
</script>

</body>
</html>